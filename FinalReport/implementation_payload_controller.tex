\section{Communication with Ground Station via Autopilot}
\label{sec:payload controller}
Considering the overall aim of this project: to produce a system by which 
images can be downloaded over-the-air from a payload module to a ground 
station, some method of communicating between the
payload module and ground station are an essential component in the system.

The specification requires the payload
module to communicate with the ground station using the autopilots payload
module interface (discussed in section \ref{sec:autopilot_payload_interface}).

%To better explain the protocol used we will split the explanation into two 
%sections: a \emph{Autopilot Payload Interface} section describing the
%pre-existing autopilot payload interface on which we are building the 
%protocol and a \emph{UAV Camera Communication Protocol} section describing the 
%protocol we have implemented as a part of this project.

\subsection{Existing Code}
\label{sec:payload_existing_code}
Our customer had provided us with some payload module communication AVR code
- written for a ATMega168 - for communicating with the autopilot. This code
was the basis on which the payload controllers communication link was built.

The code provided a number of useful utilities:
\begin{itemize}
\item Basic connection to the autopilot, including responding to transmit tokens.

\item Ability to set shared memory on the autopilot.

\item Ability to receive messages sent from the Ground Station to the 
autopilot.

\item Example code for setting shared memory on the autopilot.
\end{itemize}

This base code was modified slightly after a bug was found in its handling of 
the transmit enable signal. The RS485 communication protocol used for the 
autopilot-payload link (as described in section |||||||| SEC ||||||||) 
requires a `transmit enable' signal to be asserted when the payload is 
transmitting. This signal should be asserted just before data is to be sent 
and cleared just after. However, the original payload base code cleared this 
signal in an interrupt service routine (ISR) which fired after the transmit 
buffer of the UART was ready to accept new data. Since this transmit buffer 
would be ready to accept new data before the data was actually sent over the
physical connection this lead to the transmit enable signal being cleared
before all data had been sent, causing strange behaviour on the RS485 link.
This bug did not seem to cause any problems, and the odd behaviour was only
noticed when testing the system with an oscilloscope. ||||| INC TRACES ||||||
It was considered sensible to fix the bug in case it did cause problems later.

The fix for this problem was reasonably simple: a new ISR was set up which 
fired only when the current transmission had actually completed, and the 
command to clear the transmit enable signal was moved into this ISR.
||||| INC AFTER TRACE ||||||

\subsection{Establishing Contact with the Autopilot - (andy)}

The first step in implementing the communications link was to establish contact with
the autopilot using the existing module code, the relavant milestone being
\ref{sec:ms_pl_tx_token_resp}.

The Autopilot sends "Transmit" tokens to the payload module every 20ms, 
to which a payload module sent an "ACK" token, even when it does not 
transmit any data. We encountered a problem whereby if our we tried to 
send any data to the payload during an "ACK", the autopilot would stop 
sending any "Transmit" tokens at all, effectively cutting off all 
communication to the payload module.

\begin{figure}[H]
  \centering
  \begin{tabular}{c c}
  \subfigure{\label{fig:testing_sc2_working1}\includegraphics[width=0.5\textwidth]{scope/scope_1.png}}&                
  \subfigure{\label{fig:testing_sc2_working2}\includegraphics[width=0.5\textwidth]{scope/scope_2.png}} \\
  \subfigure{\label{fig:testing_sc2_working3}\includegraphics[width=0.5\textwidth]{scope/scope_3.png}}&                
  \subfigure{\label{fig:testing_sc2_working4}\includegraphics[width=0.5\textwidth]{scope/scope_11.png}}
  \end{tabular}
  \captionof{figure}{Oscilloscope traces for the situation where the autopilot does not break: In yellow is the Autopilot TX, in green the Payload TX. In this situation, after an ACK token is received by the autopilot, a SEND\_BYTES instruction is sent. On the next transmit token, a series of bytes is sent to the autopilot, and the autopilot continues to send Transmit tokens.}
  \label{fig:testing_sc2_working}
\end{figure}

\begin{figure}[H]
  \centering
  \begin{tabular}{c c}
  \subfigure{\label{fig:testing_sc2_broken1}\includegraphics[width=0.5\textwidth]{scope/scope_6.png}}&                
  \subfigure{\label{fig:testing_sc2_broken2}\includegraphics[width=0.5\textwidth]{scope/scope_14.png}} \\
  \subfigure{\label{fig:testing_sc2_broken3}\includegraphics[width=0.5\textwidth]{scope/scope_7.png}}
  \end{tabular}
  \captionof{figure}{Oscilloscope traces for the situation where the autopilot breaks: In yellow is the Autopilot TX, in green the Payload TX. In this situation, whilst an ACK token is received by the autopilot, a SEND\_BYTES instruction is sent. No more transmit tokens are sent, therefore communication with the payload stops.}
  \label{fig:testing_sc2_broken}
\end{figure}

Not sure whether this was a bug with the Autopilot, we got in contact with 
our customer, sending all scope traces to him and a description of how 
to reproduce the error. Not being able to reproduce it with his dummy 
payload (strange, as our dummy payloads only differed in that his used a
surface-mount version of an ATmega168 and a MAX3070 transceiver instead 
of MAX489), he then came to ECS and debugged the Autopilot with us.

After a significant amount of time debugging the Autopilot and our 
payload, it was discovered this was indeed a problem with the Autopilot, 
which our customer was able to fix and subsequently update the firmware 
of our Autopilot.

Section \ref{sec:test_pl_est_contact} describes the succesful testing of this part of
the implementation.

\subsection{Setting Shared Memory on the Autopilot - (mh23g08)}
Once basic contact had been established the next task was to set shared memory on
the autopilot - as per milestone \ref{sec:ms_pl_shared_mem_set}. The existing code
provided allowed this to be completed quickly using the built in functions. Section 
\ref{sec:test_pl_set_shared_mem} details the tests carried out to validate this
was working.

\subsection{Recieving Messages from the Ground Station - (mh23g08)}
It was important to ensure that the payload recieved messages correctly from the ground
station before continuting with the implementation of this section, the customers provided code
allowed this to be completed quickly also. Section \ref{sec:test_pl_receive_message} describes 
the steps taken to test this.

\subsection{UAV Camera Communication Protocol}
As discussed in section |||||||| REF |||||||| it was decided that 
our communications protocol would use shared memory and \emph{send\_bytes} 
commands, allowing two way communications between the payload controller and 
ground station software to be established. With the ability to recieve and send data
with these messages tested as described above, implementation could now begin on
implementing a communications protocol used to talk between the our ground station 
image viewer software and the payload.

The method through which this shared memory is accessed via the ground station
image viewer is discussed in chapter \ref{chap:implementation_ground_station}.

%The Payload Module Interface discussed above (section \ref{sec:autopilot_payload_interface})
%allows us to send strings of bytes in both directions. However, in order to 
%communicate with the ground station image viewing software some form of 
%additional communications protocol is required so that both ends of the link 
%are communicating in a mutually understandable manner.

This two way communications is the interface between the payload and the 
ground station software, so some standard protocol was required. It was decided
that a message based system would be used, with the messages from the ground
station to the payload module being sent using \emph{send\_bytes} and the 
messages sent from the payload to the ground station being put into shared
memory. Each message is composed of two elements, one byte for the message ID 
- unique to each type of message - and a variable number of data bytes 
(depending on the message type.) The different message types are detailed 
below:

\subsubsection*{Messages sent from Ground Station To Payload}

\begin{itemize}
\item \textbf{Take Picture}
\begin{itemize}
\item \emph{Data:} None
\item Prompts payload module to capture an image and save it to the SD card.
\end{itemize}

\item \textbf{Image Download Request} 
\begin{itemize}

\item \emph{Data:} Image ID
\item Requests the payload send the image with ID \emph{Image ID} to the 
ground station. This message allows any image stored by the payload module 
to be downloaded over the connection, increasing flexibility. 
\end{itemize}

\item \textbf{Configure Camera}
\begin{itemize}
\item \emph{Data:} Colour Type, Raw Image Resolution, JPEG Image
Resolution
\item Sets the image resolution and colour mode of the camera. Only the 
JPEG mode has been tested so far.
\end{itemize}

\item \textbf{Cancel Download}
\begin{itemize}
\item \emph{Data:} None
Resolution
\item Cancels the current download taking place.
\end{itemize}

\end{itemize}

\subsubsection*{Messages Sent from Payload to Ground Station}

\begin{itemize}

\item \textbf{Picture Taken}

\begin{itemize}
\item \emph{Data:} Image ID

\item Informs the ground station software that an image has been taken and 
saved to the SD card. \emph{Image ID} is the ID of the image that has been 
saved to the SD card.
\end{itemize} 

\item \textbf{Image Download Info}

\begin{itemize}

\item \emph{Data:} Number of Image Packets

\item Sent by the payload after a successful \emph{Image Download Request}
message from the ground station. Informs the ground station how many 
\emph{Image Data} packets to expect.
\end{itemize}

\item \textbf{Image Data} 
\begin{itemize}
\item \emph{Data:} Packet Number, Image Data
\item This message contains an amount of actual image data. Sent after a
\emph{Image Download Info} message which is in turn in response to an 
\emph{Image Download Request} message. The whole image is sent over
\emph{Number of Image Packets} packets (as defined by the \emph{Image Download
Info} message.) \emph{Packet Number} informs the ground station which of these
packets the message is carrying. \emph{Image Data} contains the actual image 
data for this packet and is variable size, with a maximum size of 50 bytes. 
\end{itemize}

\end{itemize}


Implementing this communications protocol was a significant challenge and was a major
component of the payload module implementation. The existing code provided by our 
customer provided some hooks for 

Figure\ref{sequence diagram} is the sequence diagram of the data transmission.
\begin{figure}[H]
\begin{center}
\includegraphics[width=1.00\textwidth]{figures/sequence_diagram.png} 
\end{center}
\caption{Sequence Diagram of the Data flow\label{sequence diagram}}
\end{figure}


|||||||| REMINDER: TALK ABOUT VOLATILE VARIABLE PROBLEM

|||||||| REMINDER: AUTOPILOT PROBLEMS

%|||||||| REMINDER: PROBLEMS CHALLENGES
%|||||||| REMINDER: HOW DID WE SOLVE PROBLEMS, DEBUGGING, TESTING, ETC
%|||||||| REMINDER: JOHN COULD TALK ABOUT HOW BROKEN CAMERAS SLOWED DOWN DEVELOPMENT BUT GOOD PLANNING AND CONTINGENCY MINIMISED RISK OR IN MANAGEMENT SECTION
%|||||||| REMINDER: FUTURE WORK
%|||||||| REMINDER: ADD NEWPAGES BETWEEN SECTIONS


